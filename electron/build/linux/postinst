#!/bin/bash
# Post-install script for Visual Git Electron

set -e

APP_DIR="/opt/Visual Git"
SANDBOX_PATH="$APP_DIR/chrome-sandbox"
APPARMOR_PROFILE="/etc/apparmor.d/visual-git"

# Fix chrome-sandbox permissions (setuid root required for sandbox)
if [ -f "$SANDBOX_PATH" ]; then
    chown root:root "$SANDBOX_PATH"
    chmod 4755 "$SANDBOX_PATH"
    echo "chrome-sandbox permissions configured"
fi

# Install AppArmor profile for Ubuntu 24.04+ user namespace support
if command -v apparmor_parser >/dev/null 2>&1; then
    cat > "$APPARMOR_PROFILE" << 'APPARMOR_EOF'
abi <abi/4.0>,
include <tunables/global>

profile visual-git /opt/Visual\ Git/visual-git-electron flags=(unconfined) {
  userns,

  include <abstractions/base>
  include <abstractions/consoles>
  include <abstractions/nameservice>

  capability,
  network,
  mount,
  remount,
  umount,
  pivot_root,
  ptrace,
  signal,
  dbus,
  unix,
  file,
}
APPARMOR_EOF

    apparmor_parser -r "$APPARMOR_PROFILE" 2>/dev/null || true
    echo "AppArmor profile installed"
fi

exit 0
